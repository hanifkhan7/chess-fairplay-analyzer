"""
Test the enhanced exploit.py module for v2.2.1
"""

import sys
from pathlib import Path

# Add parent directory to path for imports
sys.path.insert(0, str(Path(__file__).parent))

from chess_analyzer.exploit import OpponentExploiter
import chess.pgn
import io


def test_opponent_exploiter():
    """Test the OpponentExploiter class."""
    
    print("\n" + "="*70)
    print("TEST: OpponentExploiter Class")
    print("="*70 + "\n")
    
    # Create sample games for testing
    games = []
    
    # Sample game 1: White opens with Ruy Lopez
    game1 = chess.pgn.Game()
    game1.headers["White"] = "Player1"
    game1.headers["Black"] = "TestPlayer"
    game1.headers["ECO"] = "C60"
    game1.headers["Opening"] = "Ruy Lopez"
    game1.headers["Result"] = "1-0"
    game1.headers["TimeControl"] = "180+2"
    games.append(game1)
    
    # Sample game 2: Black opens with Sicilian
    game2 = chess.pgn.Game()
    game2.headers["White"] = "TestPlayer"
    game2.headers["Black"] = "Player2"
    game2.headers["ECO"] = "B20"
    game2.headers["Opening"] = "Sicilian Defense"
    game2.headers["Result"] = "0-1"
    game2.headers["TimeControl"] = "300+3"
    games.append(game2)
    
    # Sample game 3: Another Ruy Lopez
    game3 = chess.pgn.Game()
    game3.headers["White"] = "Player3"
    game3.headers["Black"] = "TestPlayer"
    game3.headers["ECO"] = "C60"
    game3.headers["Opening"] = "Ruy Lopez"
    game3.headers["Result"] = "0-1"
    game3.headers["TimeControl"] = "180+2"
    games.append(game3)
    
    # Create exploiter instance
    analyzer = OpponentExploiter(games, "TestPlayer")
    
    # Test 1: Get most played openings
    print("✓ Test 1: Most played openings")
    most_played = analyzer.get_most_played_openings()
    print(f"  Found {len(most_played)} openings")
    for eco, data in most_played[:3]:
        print(f"    - {eco}: {data['total']} games, Win rate: {data['win_rate']:.1f}%")
    
    # Test 2: Get strongest openings
    print("\n✓ Test 2: Strongest openings")
    strongest = analyzer.get_strongest_openings()
    if strongest:
        for eco, data in strongest:
            print(f"  {eco}: {data['win_rate']:.1f}% win rate")
    else:
        print("  (No data with min 3 games)")
    
    # Test 3: Get weakest openings
    print("\n✓ Test 3: Weakest openings")
    weakest = analyzer.get_weakest_openings()
    if weakest:
        for eco, data in weakest:
            print(f"  {eco}: {data['win_rate']:.1f}% win rate")
    else:
        print("  (No data with min 3 games)")
    
    # Test 4: Color preference
    print("\n✓ Test 4: Color preference")
    color_pref = analyzer.get_color_preference_analysis()
    print(f"  White games: {color_pref['white_percentage']:.1f}%")
    print(f"  Black games: {color_pref['black_percentage']:.1f}%")
    print(f"  Preference: {'White' if color_pref['prefers_white'] else 'Black'}")
    
    # Test 5: Phase strength
    print("\n✓ Test 5: Phase strength analysis")
    phases = analyzer.get_phase_strength()
    for phase, stats in phases.items():
        print(f"  {phase}: {stats['win_rate']:.1f}% ({stats['wins']}-{stats['draws']}-{stats['losses']})")
    
    # Test 6: Weaknesses detection
    print("\n✓ Test 6: Exploitable weaknesses detection")
    weaknesses = analyzer.detect_exploitable_weaknesses()
    print(f"  Opening weaknesses: {len(weaknesses['opening_weaknesses'])}")
    print(f"  Phase weaknesses: {len(weaknesses['phase_weaknesses'])}")
    print(f"  Time control weaknesses: {len(weaknesses['time_control_weaknesses'])}")
    
    # Test 7: Full report
    print("\n✓ Test 7: Full report generation")
    report = analyzer.get_full_report()
    print(f"  Player: {report['player']}")
    print(f"  Total games: {report['total_games']}")
    print(f"  Most played openings: {len(report['most_played_openings'])}")
    
    print("\n" + "="*70)
    print("✓ All tests passed!")
    print("="*70 + "\n")


if __name__ == "__main__":
    test_opponent_exploiter()
