"""
Enhanced Player Analysis: "Exploit your opponent" feature for Chess Detective v2.2.1
Detailed opening analysis, performance metrics, and strategic exploitable weaknesses.
"""

from typing import List, Dict, Tuple
from collections import defaultdict
import statistics


class OpponentExploiter:
    """Analyze player weaknesses and provide exploitation strategies."""
    
    def __init__(self, games: List, username: str):
        """
        Initialize opponent analysis.
        
        Args:
            games: List of chess games
            username: Target player username
        """
        self.games = games
        self.username = username.lower()
        self.opening_data = defaultdict(lambda: {
            'white_wins': 0, 'white_losses': 0, 'white_draws': 0,
            'black_wins': 0, 'black_losses': 0, 'black_draws': 0,
            'total': 0, 'win_rate': 0, 'eco': '', 'full_name': ''
        })
        self.phase_stats = {'opening': [], 'middlegame': [], 'endgame': []}
        self.time_control_stats = defaultdict(lambda: {
            'wins': 0, 'losses': 0, 'draws': 0, 'total': 0
        })
        self.color_preference = {'white': 0, 'black': 0}
        self.against_strength = defaultdict(list)
        self._analyze()
    
    def _analyze(self):
        """Perform comprehensive analysis."""
        for game in self.games:
            headers = game.headers
            white = headers.get("White", "").lower()
            black = headers.get("Black", "").lower()
            is_player_white = white == self.username
            
            # Track color preference
            if is_player_white:
                self.color_preference['white'] += 1
            else:
                self.color_preference['black'] += 1
            
            # Extract game info
            result = headers.get('Result', '*')
            eco = headers.get('ECO', 'Unknown')
            opening_name = headers.get('Opening', 'Unknown')
            time_control = headers.get('TimeControl', 'Unknown')
            
            # Determine outcome from player's perspective
            if result == '1-0':
                player_result = 'win' if is_player_white else 'loss'
            elif result == '0-1':
                player_result = 'loss' if is_player_white else 'win'
            else:
                player_result = 'draw'
            
            # Opening analysis
            opening_key = f"{eco}"
            if opening_key not in self.opening_data:
                self.opening_data[opening_key] = {
                    'white_wins': 0, 'white_losses': 0, 'white_draws': 0,
                    'black_wins': 0, 'black_losses': 0, 'black_draws': 0,
                    'total': 0, 'win_rate': 0, 'eco': eco, 'full_name': opening_name,
                    'against_white': [], 'against_black': []
                }
            
            self.opening_data[opening_key]['total'] += 1
            
            if is_player_white:
                if player_result == 'win':
                    self.opening_data[opening_key]['white_wins'] += 1
                elif player_result == 'loss':
                    self.opening_data[opening_key]['white_losses'] += 1
                else:
                    self.opening_data[opening_key]['white_draws'] += 1
                self.opening_data[opening_key]['against_black'].append(player_result)
            else:
                if player_result == 'win':
                    self.opening_data[opening_key]['black_wins'] += 1
                elif player_result == 'loss':
                    self.opening_data[opening_key]['black_losses'] += 1
                else:
                    self.opening_data[opening_key]['black_draws'] += 1
                self.opening_data[opening_key]['against_white'].append(player_result)
            
            # Time control analysis
            self.time_control_stats[time_control]['total'] += 1
            if player_result == 'win':
                self.time_control_stats[time_control]['wins'] += 1
            elif player_result == 'loss':
                self.time_control_stats[time_control]['losses'] += 1
            else:
                self.time_control_stats[time_control]['draws'] += 1
            
            # Phase analysis
            move_count = len(list(game.mainline_moves()))
            if move_count <= 12:
                phase = 'opening'
            elif move_count <= 40:
                phase = 'middlegame'
            else:
                phase = 'endgame'
            
            self.phase_stats[phase].append(player_result)
            
            # Opponent strength tracking
            opponent_elo = headers.get("BlackElo" if is_player_white else "WhiteElo")
            try:
                if opponent_elo:
                    self.against_strength[int(opponent_elo)] = player_result
            except:
                pass
        
        # Calculate opening win rates
        for opening_key, data in self.opening_data.items():
            if data['total'] > 0:
                wins = data['white_wins'] + data['black_wins']
                data['win_rate'] = (wins / data['total'] * 100)
    
    def get_most_played_openings(self, n: int = 10) -> List[Tuple[str, Dict]]:
        """Get most played openings."""
        sorted_openings = sorted(
            self.opening_data.items(),
            key=lambda x: x[1]['total'],
            reverse=True
        )
        return sorted_openings[:n]
    
    def get_weakest_openings(self, min_games: int = 3) -> List[Tuple[str, Dict]]:
        """Get openings where player performs worst."""
        weak = []
        for eco, data in self.opening_data.items():
            if data['total'] >= min_games:
                weak.append((eco, data))
        
        weak.sort(key=lambda x: x[1]['win_rate'])
        return weak[:5]
    
    def get_strongest_openings(self, min_games: int = 3) -> List[Tuple[str, Dict]]:
        """Get openings where player performs best."""
        strong = []
        for eco, data in self.opening_data.items():
            if data['total'] >= min_games:
                strong.append((eco, data))
        
        strong.sort(key=lambda x: x[1]['win_rate'], reverse=True)
        return strong[:5]
    
    def get_color_preference_analysis(self) -> Dict:
        """Analyze color preference and performance."""
        total = self.color_preference['white'] + self.color_preference['black']
        
        return {
            'prefers_white': self.color_preference['white'] > self.color_preference['black'],
            'white_percentage': (self.color_preference['white'] / total * 100) if total > 0 else 0,
            'black_percentage': (self.color_preference['black'] / total * 100) if total > 0 else 0,
            'white_games': self.color_preference['white'],
            'black_games': self.color_preference['black']
        }
    
    def get_phase_strength(self) -> Dict[str, Dict]:
        """Analyze performance by game phase."""
        phase_analysis = {}
        
        for phase, results in self.phase_stats.items():
            if results:
                wins = results.count('win')
                losses = results.count('loss')
                draws = results.count('draw')
                total = len(results)
                
                phase_analysis[phase] = {
                    'wins': wins,
                    'losses': losses,
                    'draws': draws,
                    'total': total,
                    'win_rate': (wins / total * 100) if total > 0 else 0
                }
        
        return phase_analysis
    
    def get_time_control_performance(self) -> Dict[str, Dict]:
        """Get performance breakdown by time control."""
        performance = {}
        
        for tc, stats in self.time_control_stats.items():
            if stats['total'] > 0:
                performance[tc] = {
                    'wins': stats['wins'],
                    'losses': stats['losses'],
                    'draws': stats['draws'],
                    'total': stats['total'],
                    'win_rate': (stats['wins'] / stats['total'] * 100) if stats['total'] > 0 else 0
                }
        
        return performance
    
    def detect_exploitable_weaknesses(self) -> Dict[str, List[Dict]]:
        """Detect specific weaknesses to exploit."""
        weaknesses = {'opening_weaknesses': [], 'phase_weaknesses': [], 'time_control_weaknesses': []}
        
        # Opening weaknesses
        weak_openings = self.get_weakest_openings(min_games=2)
        for eco, data in weak_openings:
            if data['win_rate'] < 40:  # <40% win rate = exploitable
                weaknesses['opening_weaknesses'].append({
                    'eco': eco,
                    'opening_name': data['full_name'],
                    'win_rate': data['win_rate'],
                    'games_played': data['total'],
                    'strategy': self._get_opening_strategy(eco, data)
                })
        
        # Phase weaknesses
        phases = self.get_phase_strength()
        for phase, stats in phases.items():
            if stats['win_rate'] < 45:  # <45% win rate in phase
                weaknesses['phase_weaknesses'].append({
                    'phase': phase,
                    'win_rate': stats['win_rate'],
                    'games': stats['total'],
                    'strategy': self._get_phase_strategy(phase)
                })
        
        # Time control weaknesses
        time_perf = self.get_time_control_performance()
        for tc, stats in time_perf.items():
            if stats['win_rate'] < 45 and stats['total'] >= 3:
                weaknesses['time_control_weaknesses'].append({
                    'time_control': tc,
                    'win_rate': stats['win_rate'],
                    'games': stats['total'],
                    'strategy': f"Play {tc} time control to exploit weakness"
                })
        
        return weaknesses
    
    def _get_opening_strategy(self, eco: str, data: Dict) -> str:
        """Generate strategy for exploiting opening weakness."""
        if data['win_rate'] < 30:
            return f"Extremely weak in {eco}. Play it consistently to exploit."
        elif data['win_rate'] < 40:
            return f"Significant weakness in {eco}. Prepare deeply for this line."
        else:
            return f"Vulnerable in {eco}. Can be exploited with proper preparation."
    
    def _get_phase_strategy(self, phase: str) -> str:
        """Generate strategy for exploiting phase weakness."""
        strategies = {
            'opening': "Focus on sharp, tactical openings. Push for complications early.",
            'middlegame': "Avoid simplifications. Keep position complex with multiple threats.",
            'endgame': "Simplify and trade pieces to reach endgame. Technical skill advantage."
        }
        return strategies.get(phase, "Adjust strategy for this phase.")
    
    def get_full_report(self) -> Dict:
        """Get comprehensive exploitation report."""
        return {
            'player': self.username,
            'total_games': len(self.games),
            'most_played_openings': self.get_most_played_openings(),
            'strongest_openings': self.get_strongest_openings(),
            'weakest_openings': self.get_weakest_openings(),
            'color_preference': self.get_color_preference_analysis(),
            'phase_strength': self.get_phase_strength(),
            'time_control_performance': self.get_time_control_performance(),
            'exploitable_weaknesses': self.detect_exploitable_weaknesses()
        }


def display_exploit_analysis(games, username: str):
    """Display comprehensive exploitation analysis."""
    print("\n" + "="*80)
    print(f"  EXPLOIT YOUR OPPONENT - {username.upper()}")
    print("="*80 + "\n")
    
    analyzer = OpponentExploiter(games, username)
    report = analyzer.get_full_report()
    
    # Overall stats
    total = report['total_games']
    print(f"Games Analyzed: {total}\n")
    
    # Most played openings
    print("-"*80)
    print("  TOP 10 MOST PLAYED OPENINGS")
    print("-"*80)
    
    most_played = report['most_played_openings']
    if most_played:
        print(f"  {'ECO':<8} {'Opening':<40} {'Games':<8} {'Win %':<10}")
        print("  " + "-"*75)
        for eco, data in most_played:
            opening_name = data['full_name'][:35] if data['full_name'] != 'Unknown' else 'Unknown'
            print(f"  {eco:<8} {opening_name:<40} {data['total']:<8} {data['win_rate']:<10.1f}%")
    
    # Strongest openings (to prepare against)
    print("\n" + "-"*80)
    print("  STRONGEST OPENINGS (AVOID OR PREPARE CAREFULLY)")
    print("-"*80)
    
    strongest = report['strongest_openings']
    if strongest:
        print(f"  {'ECO':<8} {'Opening':<40} {'Win %':<10}")
        print("  " + "-"*75)
        for eco, data in strongest:
            opening_name = data['full_name'][:35] if data['full_name'] != 'Unknown' else 'Unknown'
            print(f"  {eco:<8} {opening_name:<40} {data['win_rate']:<10.1f}%")
    
    # Weakest openings (to target)
    print("\n" + "-"*80)
    print("  WEAKEST OPENINGS (TARGET THESE!)")
    print("-"*80)
    
    weakest = report['weakest_openings']
    if weakest:
        print(f"  {'ECO':<8} {'Opening':<40} {'Win %':<10} {'Games':<8}")
        print("  " + "-"*75)
        for eco, data in weakest:
            opening_name = data['full_name'][:35] if data['full_name'] != 'Unknown' else 'Unknown'
            severity = "ðŸ”´ CRITICAL" if data['win_rate'] < 30 else "ðŸŸ¡ WEAK" if data['win_rate'] < 40 else "ðŸŸ  VULNERABLE"
            print(f"  {eco:<8} {opening_name:<40} {data['win_rate']:<10.1f}% {severity}")
    
    # Color preference
    print("\n" + "-"*80)
    print("  COLOR PREFERENCE & ANALYSIS")
    print("-"*80)
    
    color_data = report['color_preference']
    white_pct = color_data['white_percentage']
    black_pct = color_data['black_percentage']
    
    print(f"  Prefers White: {white_pct:.1f}% ({color_data['white_games']} games)")
    print(f"  Prefers Black: {black_pct:.1f}% ({color_data['black_games']} games)")
    
    if white_pct > 60:
        print(f"  â†’ ðŸ’¡ EXPLOIT: Force Black against this player (weaker with Black)")
    elif black_pct > 60:
        print(f"  â†’ ðŸ’¡ EXPLOIT: Force White against this player (weaker with White)")
    else:
        print(f"  â†’ Balanced play - color less relevant for exploitation")
    
    # Phase strength
    print("\n" + "-"*80)
    print("  PHASE STRENGTH ANALYSIS")
    print("-"*80)
    
    phases = report['phase_strength']
    for phase in ['opening', 'middlegame', 'endgame']:
        if phase in phases:
            stats = phases[phase]
            wr = stats['win_rate']
            print(f"\n  {phase.upper()}:")
            print(f"    Win Rate: {wr:.1f}% ({stats['wins']}-{stats['draws']}-{stats['losses']})")
            
            if wr < 40:
                print(f"    ðŸŽ¯ CRITICAL WEAKNESS - ATTACK IN {phase.upper()}")
            elif wr < 45:
                print(f"    âš ï¸  WEAKNESS - Try to shift play to this phase")
            elif wr > 55:
                print(f"    âœ“ Strong - Avoid prolonging into this phase")
    
    # Time control performance
    print("\n" + "-"*80)
    print("  TIME CONTROL PERFORMANCE")
    print("-"*80)
    
    time_perf = report['time_control_performance']
    if time_perf:
        print(f"  {'Time Control':<20} {'Win %':<10} {'W-D-L':<20} {'Games':<8}")
        print("  " + "-"*75)
        for tc, stats in sorted(time_perf.items(), key=lambda x: x[1]['total'], reverse=True):
            w, d, l = stats['wins'], stats['draws'], stats['losses']
            print(f"  {tc:<20} {stats['win_rate']:<10.1f}% {w}-{d}-{l:<18} {stats['total']:<8}")
    
    # Exploitable weaknesses summary
    print("\n" + "-"*80)
    print("  ðŸŽ¯ EXPLOITATION STRATEGY")
    print("-"*80)
    
    weaknesses = report['exploitable_weaknesses']
    
    if weaknesses['opening_weaknesses']:
        print(f"\n  OPENING EXPLOITATION:")
        for weakness in weaknesses['opening_weaknesses']:
            print(f"    â€¢ {weakness['eco']} ({weakness['opening_name']}): {weakness['win_rate']:.1f}%")
            print(f"      â””â”€ {weakness['strategy']}")
    
    if weaknesses['phase_weaknesses']:
        print(f"\n  PHASE EXPLOITATION:")
        for weakness in weaknesses['phase_weaknesses']:
            print(f"    â€¢ In {weakness['phase']}: {weakness['win_rate']:.1f}% win rate")
            print(f"      â””â”€ {weakness['strategy']}")
    
    if weaknesses['time_control_weaknesses']:
        print(f"\n  TIME CONTROL EXPLOITATION:")
        for weakness in weaknesses['time_control_weaknesses']:
            print(f"    â€¢ {weakness['time_control']}: {weakness['win_rate']:.1f}% win rate")
            print(f"      â””â”€ {weakness['strategy']}")
    
    if not any(weaknesses.values()):
        print("\n  âœ“ No critical weaknesses detected. Player is well-balanced.")
    
    print("\n" + "="*80 + "\n")
